{% extends 'base.html' %}

{% block title %}问答机器人{% endblock %}

{% block content %}
<div class="container mx-auto p-4 max-w-md">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-4 bg-blue-500 text-white text-center font-bold">问答机器人</div>
        <div id="chat-window" class="h-96 overflow-y-auto p-4 space-y-4">
            <!-- 聊天消息将在这里动态添加 -->
        </div>
        <div class="flex p-4 border-t border-gray-200">
            <input type="text" id="question-input" class="flex-1 border border-gray-300 rounded-md p-2 mr-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="输入你的问题">
            <button id="send-button" class="bg-blue-500 text-white rounded-md p-2 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const questionInput = document.getElementById('question-input');
    const sendButton = document.getElementById('send-button');

    sendButton.addEventListener('click', async () => {
        const question = questionInput.value.trim();
        if (question) {
            // 显示用户问题
            const userMessage = document.createElement('div');
            userMessage.classList.add('flex', 'justify-end');
            userMessage.innerHTML = `<div class="bg-blue-100 text-blue-800 p-3 rounded-md max-w-xs">${question}</div>`;
            chatWindow.appendChild(userMessage);
            questionInput.value = '';

            try {
                // 发送请求到后端 API
                const response = await fetch('/chat/api/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();
                if (data.error) {
                    // 显示错误消息
                    const errorMessage = document.createElement('div');
                    errorMessage.classList.add('flex', 'justify-start');
                    errorMessage.innerHTML = `<div class="bg-red-100 text-red-800 p-3 rounded-md max-w-xs">${data.error}</div>`;
                    chatWindow.appendChild(errorMessage);
                } else {
                    // 显示机器人回答
                    const botMessage = document.createElement('div');
                    botMessage.classList.add('flex', 'justify-start');
                    botMessage.innerHTML = `<div class="bg-gray-100 text-gray-800 p-3 rounded-md max-w-xs">${data.answer}</div>`;
                    chatWindow.appendChild(botMessage);
                }
            } catch (error) {
                // 显示网络错误消息
                const networkError = document.createElement('div');
                networkError.classList.add('flex', 'justify-start');
                networkError.innerHTML = `<div class="bg-red-100 text-red-800 p-3 rounded-md max-w-xs">网络错误，请稍后再试</div>`;
                chatWindow.appendChild(networkError);
            }

            // 滚动到聊天窗口底部
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    });

    // 支持回车键发送问题
    questionInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            sendButton.click();
        }
    });
</script>
{% endblock %}