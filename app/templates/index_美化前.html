{% extends "base.html" %}

{% block title %}æ°´åˆ©çŸ¥è¯†å¹³å°{% endblock %}

{% block content %}
<style>
    /* æ–°å¢çŸ¥è¯†å›¾è°±å®¹å™¨æ ·å¼ */
    .knowledge-graph-section {
        margin: 30px 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .graph-header {
        padding: 15px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
    }

    #graph-container {
        height: 500px;
        width: 100%;
        border: 1px solid #ddd;
    }

    /* è°ƒæ•´åŸæœ‰å¸ƒå±€é—´è· */
    .recent-added {
        margin-top: 30px;
    }

    .knowledge-graph-section .btn {
        white-space: nowrap;
        margin-left: 15px;
        display: inline-flex;
        align-items: center;
    }

    .knowledge-graph-section .btn i {
        margin-right: 5px;
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
        .graph-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .knowledge-graph-section .btn {
            margin: 10px 0 0 0;
            align-self: flex-end;
        }
    }
</style>
<div class="dashboard">
    <section class="welcome-banner">
        <h1>æ¬¢è¿ä½¿ç”¨æ°´åˆ©çŸ¥è¯†ç®¡ç†å¹³å°</h1>
        <p class="subtitle">ä¸€ä½“åŒ–æ°´åˆ©è®¾æ–½æ•°æ®ç®¡ç†ä¸åˆ†æç³»ç»Ÿ</p>
    </section>

    <div class="stats-cards">
        <div class="card">
            <h3><a href="{{ url_for('basin.list_basins') }}">æµåŸŸæ•°æ®</a></h3>
            <div class="stat">{{ basin_count }}</div>
            <p>ç™»è®°æµåŸŸæ•°é‡</p>
        </div>

        <div class="card">
            <h3><a href="{{ url_for('river.list_rivers') }}">æ²³æµæ•°æ®</a></h3>
            <div class="stat">{{ river_count }}</div>
            <p>ç›‘æµ‹æ²³æµæ•°é‡</p>
        </div>

        <div class="card">
            <h3><a href="{{ url_for('reservoir.list_reservoirs') }}">æ°´åº“æ•°æ®</a></h3>
            <div class="stat">{{ reservoir_count }}</div>
            <p>ç®¡ç†æ°´åº“æ•°é‡</p>
        </div>

        <div class="card">
            <h3><a href="{{ url_for('station.list_stations') }}">æ°”è±¡ç›‘æµ‹</a></h3>
            <div class="stat">{{ station_count }}</div>
            <p>æ°”è±¡ç«™ç‚¹æ•°é‡</p>
        </div>
    </div>
    <!-- æ–°å¢çŸ¥è¯†å›¾è°±éƒ¨åˆ† -->
    <section class="knowledge-graph-section">
        <div class="graph-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2><i class="bi bi-diagram-3"></i> æ°´åˆ©çŸ¥è¯†å›¾è°±</h2>
                    <p>å¯è§†åŒ–å±•ç¤ºæ°´åˆ©è®¾æ–½å…³è”å…³ç³»</p>
                </div>
                <a href="{{ url_for('main.knowledge_graph') }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-right-circle"></i> æŸ¥çœ‹å®Œæ•´å›¾è°±
                </a>
            </div>
        </div>
        <div id="graph-container">
            <div id="graph-loading">æ­£åœ¨åŠ è½½çŸ¥è¯†å›¾è°±...</div>
            <svg id="graph-svg">
                <g id="zoomable-container"></g>
            </svg>
        </div>
    </section>

    <section class="quick-actions">
        <h2>å¿«é€Ÿæ“ä½œ</h2>
        <div class="action-buttons">
            <a href="{{ url_for('basin.create_basin') }}" class="action-btn">
                <i class="icon">ğŸï¸</i>
                <span>æ–°å¢æµåŸŸ</span>
            </a>
            <a href="{{ url_for('river.create_river') }}" class="action-btn">
                <i class="icon">ğŸŒŠ</i>
                <span>ç™»è®°æ²³æµ</span>
            </a>
            <a href="{{ url_for('monitor.create_monitor') }}" class="action-btn">
                <i class="icon">ğŸ“Š</i>
                <span>æ·»åŠ ç›‘æµ‹ç«™</span>
            </a>
            <a href="{{ url_for('facility.create_facility') }}" class="action-btn">
                <i class="icon">ğŸ›¡ï¸</i>
                <span>è®°å½•é˜²æ´ªè®¾æ–½</span>
            </a>
        </div>
    </section>

    <section class="recent-added">
        <h2>æœ€è¿‘æ·»åŠ </h2>
        <div class="recent-items">
            <div class="recent-column">
                <h4><i class="icon">ğŸ†•</i> æœ€æ–°æµåŸŸ</h4>
                {% if recent_basins %}
                <ul>
                    {% for basin in recent_basins %}
                    <li>
                        <a href="{{ url_for('basin.edit_basin', basin_id=basin.basin_id) }}">
                            {{ basin.name }} ({{ basin.region }})
                        </a>
                        <span class="recent-time">{{ basin.created_at.strftime('%Y-%m-%d') if basin.created_at else '' }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="no-data">æš‚æ— æµåŸŸæ•°æ®</p>
                {% endif %}
            </div>

            <div class="recent-column">
                <h4><i class="icon">ğŸ†•</i> æœ€æ–°ç›‘æµ‹ç«™</h4>
                {% if recent_monitors %}
                <ul>
                    {% for monitor in recent_monitors %}
                    <li>
                        <a href="{{ url_for('monitor.edit_monitor', monitor_id=monitor.monitor_id) }}">
                            {{ monitor.name }} ({{ monitor.type }})
                        </a>
                        <span class="recent-time">{{ monitor.created_at.strftime('%Y-%m-%d') if monitor.created_at else '' }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="no-data">æš‚æ— ç›‘æµ‹ç«™æ•°æ®</p>
                {% endif %}
            </div>
        </div>
    </section>
</div>
<script>
    // é…ç½®å¯¹è±¡
    const config = {
        nodeRadius: 12,
        linkDistance: 120,
        chargeStrength: -150,
        nodeColors: {
            "River": "#1f77b4",
            "Basin": "#ff7f0e",
            "Reservoir": "#2ca02c",
            "FloodControlFacility": "#d62728",
            "WeatherStation": "#9467bd",
            "MonitoringStation": "#8c564b"
        }
    };

    // åˆå§‹åŒ–å›¾å½¢
    function initGraph() {
        const container = document.getElementById('graph-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3.select('#graph-svg')
            .attr('width', width)
            .attr('height', height);

        // æ·»åŠ ç¼©æ”¾è¡Œä¸º
        const zoom = d3.zoom()
            .scaleExtent([0.1, 8])
            .on('zoom', (event) => {
                d3.select('#zoomable-container').attr('transform', event.transform);
            });
        svg.call(zoom);

        // æ‰§è¡Œé»˜è®¤æŸ¥è¯¢
        executeDefaultQuery();
    }

    // æ‰§è¡Œé»˜è®¤æŸ¥è¯¢
    async function executeDefaultQuery() {
        const loadingEl = document.getElementById('graph-loading');
        try {
            loadingEl.style.display = 'block';

            const response = await axios.post('/neo4j/query', {
                query: "MATCH (n)-[r]->(m) RETURN n, labels(n) as n_labels, r, m, labels(m) as m_labels",
                parameters: {}
            });

            const data = transformData(response.data);
            renderGraph(data);

        } catch (error) {
            console.error('åŠ è½½çŸ¥è¯†å›¾è°±å¤±è´¥:', error);
            loadingEl.textContent = 'åŠ è½½å¤±è´¥: ' + (error.response?.data?.error || error.message);
        } finally {
            loadingEl.style.display = 'none';
        }
    }

    // æ•°æ®è½¬æ¢
    function transformData(neo4jData) {
        const nodes = [];
        const links = [];
        const nodeMap = new Map();

        neo4jData.data.forEach(record => {
            // å¤„ç†èŠ‚ç‚¹n
            if (record._fields[0]) {
                const nodeData = record._fields[0];
                const nodeId = nodeData.id || nodeData._id || JSON.stringify(nodeData);
                const labels = record._fields[record._fieldLookup.n_labels] || ['Node'];

                if (!nodeMap.has(nodeId)) {
                    nodes.push({
                        id: nodeId,
                        type: labels[0],
                        label: nodeData.name || labels[0],
                        properties: nodeData
                    });
                    nodeMap.set(nodeId, true);
                }
            }

            // å¤„ç†èŠ‚ç‚¹m
            if (record._fields[record._fieldLookup.m]) {
                const nodeData = record._fields[record._fieldLookup.m];
                const nodeId = nodeData.id || nodeData._id || JSON.stringify(nodeData);
                const labels = record._fields[record._fieldLookup.m_labels] || ['Node'];

                if (!nodeMap.has(nodeId)) {
                    nodes.push({
                        id: nodeId,
                        type: labels[0],
                        label: nodeData.name || labels[0],
                        properties: nodeData
                    });
                    nodeMap.set(nodeId, true);
                }
            }

            // å¤„ç†å…³ç³»
            if (record._fields[record._fieldLookup.r]) {
                const relData = record._fields[record._fieldLookup.r];
                const sourceNode = record._fields[record._fieldLookup.n];
                const targetNode = record._fields[record._fieldLookup.m];

                if (sourceNode && targetNode) {
                    const sourceId = sourceNode.id || sourceNode._id || JSON.stringify(sourceNode);
                    const targetId = targetNode.id || targetNode._id || JSON.stringify(targetNode);

                    links.push({
                        source: sourceId,
                        target: targetId,
                        type: relData.type || 'RELATED'
                    });
                }
            }
        });

        return {nodes, links};
    }

    // æ¸²æŸ“å›¾å½¢
    function renderGraph(data) {
        const svg = d3.select('#graph-svg');

        // æ¸…é™¤ç°æœ‰å›¾å½¢
        svg.selectAll('#zoomable-container *').remove();

        // åˆ›å»ºåŠ›å¯¼å‘æ¨¡æ‹Ÿ
        const simulation = d3.forceSimulation(data.nodes)
            .force('link', d3.forceLink(data.links).id(d => d.id).distance(config.linkDistance))
            .force('charge', d3.forceManyBody().strength(config.chargeStrength))
            .force('center', d3.forceCenter(svg.attr('width') / 2, svg.attr('height') / 2));

        // åˆ›å»ºè¿çº¿
        const link = svg.select('#zoomable-container').append('g')
            .selectAll('line')
            .data(data.links)
            .enter().append('line')
            .attr('class', 'link')
            .attr('stroke', '#999');

        // åˆ›å»ºèŠ‚ç‚¹
        const node = svg.select('#zoomable-container').append('g')
            .selectAll('circle')
            .data(data.nodes)
            .enter().append('circle')
            .attr('class', 'node')
            .attr('r', config.nodeRadius)
            .attr('fill', d => config.nodeColors[d.type] || '#aaa')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));

        // æ·»åŠ èŠ‚ç‚¹æ ‡ç­¾
        const text = svg.select('#zoomable-container').append('g')
            .selectAll('text')
            .data(data.nodes)
            .enter().append('text')
            .attr('dy', -15)
            .text(d => d.label)
            .attr('font-size', 10);

        // æ›´æ–°æ¨¡æ‹Ÿ
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);

            text
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initGraph);
</script>
{% endblock %}
